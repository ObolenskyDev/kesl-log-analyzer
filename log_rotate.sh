#!/bin/bash
# –°–∫—Ä–∏–ø—Ç —Ä–æ—Ç–∞—Ü–∏–∏ –∏ –æ—á–∏—Å—Ç–∫–∏ —Å—Ç–∞—Ä—ã—Ö –ª–æ–≥–æ–≤ KESL.
# –°–∂–∏–º–∞–µ—Ç –ª–æ–≥–∏ —Å—Ç–∞—Ä—à–µ 7 –¥–Ω–µ–π, —É–¥–∞–ª—è–µ—Ç –∞—Ä—Ö–∏–≤—ã —Å—Ç–∞—Ä—à–µ 30 –¥–Ω–µ–π.

LOG_DIR="./logs" # –†–∞–±–æ—Ç–∞–µ–º –≤ –ª–æ–∫–∞–ª—å–Ω–æ–π –ø–∞–ø–∫–µ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ —Ç–µ—Å—Ç–∞

# –¶–≤–µ—Ç–∞
GREEN='\033[0;32m'
BLUE='\033[0;34m'
NC='\033[0m'

echo -e "${BLUE}--- [MAINTENANCE] –û–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ –ª–æ–≥–æ–≤ ---${NC}"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
if [ ! -d "$LOG_DIR" ]; then
    echo "–ü–∞–ø–∫–∞ $LOG_DIR –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –°–æ–∑–¥–∞—é –¥–µ–º–æ-—Å—Ç—Ä—É–∫—Ç—É—Ä—É..."
    mkdir -p "$LOG_DIR"
    # –°–æ–∑–¥–∞–µ–º —Ñ–µ–π–∫–æ–≤—ã–µ —Å—Ç–∞—Ä—ã–µ –ª–æ–≥–∏ –¥–ª—è —Ç–µ—Å—Ç–∞
    touch "$LOG_DIR/trace.log"
    touch "$LOG_DIR/old_trace.log.2025-12-01" 
fi

# 1. –ê—Ä—Ö–∏–≤–∞—Ü–∏—è
echo "üì¶ –°–∂–∞—Ç–∏–µ —Å—Ç–∞—Ä—ã—Ö –ª–æ–≥–æ–≤..."
count=0
# –í –±–æ–µ–≤–æ–π —Å—Ä–µ–¥–µ —Ç—É—Ç –±—ã–ª–æ –±—ã: find $LOG_DIR -mtime +7 ...
for file in "$LOG_DIR"/*; do
    if [[ -f "$file" && "$file" != *.gz && "$file" != *"kesl_trace.log"* ]]; then
        echo "   Gzipping: $file"
        gzip -f "$file"
        ((count++))
    fi
done
echo -e "${GREEN}‚úÖ –°–∂–∞—Ç–æ —Ñ–∞–π–ª–æ–≤: $count${NC}"

# 2. –û—á–∏—Å—Ç–∫–∞
echo "üóëÔ∏è  –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö –∞—Ä—Ö–∏–≤–æ–≤ (>30 –¥–Ω–µ–π)..."
# –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –∫–æ–º–∞–Ω–¥—ã (Dry Run)
echo "   [DRY RUN] find $LOG_DIR -name '*.gz' -mtime +30 -delete"

echo -e "${GREEN}‚úÖ –†–æ—Ç–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞.${NC}"